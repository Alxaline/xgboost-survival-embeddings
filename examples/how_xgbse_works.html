
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Better XGBoost survival analysis with embeddings and debiased estimators.">
      
      
      
        <meta name="author" content="Loft Data Science Team">
      
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-6.2.4">
    
    
      
        <title>How XGBSE works - XGBoost Survival Embeddings</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.15aa0b43.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.75751829.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
      
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#how-xgbse-works" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

  

<header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="../index.html" title="XGBoost Survival Embeddings" class="md-header-nav__button md-logo" aria-label="XGBoost Survival Embeddings">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      <div class="md-header-nav__ellipsis">
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            XGBoost Survival Embeddings
          </span>
        </div>
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            
              How XGBSE works
            
          </span>
        </div>
      </div>
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/loft-br/xgboost-survival-embeddings/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  




<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../index.html" title="XGBoost Survival Embeddings" class="md-nav__button md-logo" aria-label="XGBoost Survival Embeddings">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    XGBoost Survival Embeddings
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/loft-br/xgboost-survival-embeddings/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      



  <li class="md-nav__item">
    <a href="../index.html" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      



  <li class="md-nav__item">
    <a href="../basic-usage.html" class="md-nav__link">
      Basic Usage
    </a>
  </li>

    
      
      
      



  
  <li class="md-nav__item md-nav__item--nested">
    
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" >
    
    <label class="md-nav__link" for="nav-3">
      Modules
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Modules" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        <span class="md-nav__icon md-icon"></span>
        Modules
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          



  <li class="md-nav__item">
    <a href="../base.html" class="md-nav__link">
      Base
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../bce.html" class="md-nav__link">
      BCE
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../kaplan.html" class="md-nav__link">
      Kaplan
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../meta.html" class="md-nav__link">
      Meta
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../extrapolation.html" class="md-nav__link">
      Extrapolation
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../converters.html" class="md-nav__link">
      Converters
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../metrics.html" class="md-nav__link">
      Metrics
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  


  
  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4" checked>
    
    <label class="md-nav__link" for="nav-4">
      Examples
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Examples" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        <span class="md-nav__icon md-icon"></span>
        Examples
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        How XGBSE works
        <span class="md-nav__icon md-icon"></span>
      </label>
    
    <a href="how_xgbse_works.html" class="md-nav__link md-nav__link--active">
      How XGBSE works
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#how-xgbse-works" class="md-nav__link">
    How xgbse works
  </a>
  
    <nav class="md-nav" aria-label="How xgbse works">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#what-xgbse-tries-to-solve" class="md-nav__link">
    What xgbse tries to solve
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#leveraging-xgboost-as-a-feature-transformer" class="md-nav__link">
    Leveraging xgboost as a feature transformer
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xgbsedebiasedbce-logistic-regressions-time-windows-embedding-as-input" class="md-nav__link">
    XGBSEDebiasedBCE: logistic regressions, time windows, embedding as input
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xgbsekaplanneighbors-kaplan-meier-on-nearest-neighbors" class="md-nav__link">
    XGBSEKaplanNeighbors: Kaplan-Meier on nearest neighbors
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xgbsekaplantree-single-tree-and-kaplan-meier-on-its-leaves" class="md-nav__link">
    XGBSEKaplanTree: single tree, and Kaplan-Meier on its leaves
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#does-it-solve-the-problem" class="md-nav__link">
    Does it solve the problem?
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      



  <li class="md-nav__item">
    <a href="../benchmarks/benchmarks.html" class="md-nav__link">
      Benchmarks
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#how-xgbse-works" class="md-nav__link">
    How xgbse works
  </a>
  
    <nav class="md-nav" aria-label="How xgbse works">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#what-xgbse-tries-to-solve" class="md-nav__link">
    What xgbse tries to solve
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#leveraging-xgboost-as-a-feature-transformer" class="md-nav__link">
    Leveraging xgboost as a feature transformer
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xgbsedebiasedbce-logistic-regressions-time-windows-embedding-as-input" class="md-nav__link">
    XGBSEDebiasedBCE: logistic regressions, time windows, embedding as input
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xgbsekaplanneighbors-kaplan-meier-on-nearest-neighbors" class="md-nav__link">
    XGBSEKaplanNeighbors: Kaplan-Meier on nearest neighbors
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xgbsekaplantree-single-tree-and-kaplan-meier-on-its-leaves" class="md-nav__link">
    XGBSEKaplanTree: single tree, and Kaplan-Meier on its leaves
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#does-it-solve-the-problem" class="md-nav__link">
    Does it solve the problem?
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/loft-br/xgboost-survival-embeddings/edit/master/docs/examples/how_xgbse_works.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                  <h1>How XGBSE works</h1>
                
                <h2 id="how-xgbse-works">How <code>xgbse</code> works<a class="headerlink" href="#how-xgbse-works" title="Permanent link">&para;</a></h2>
<p>In this section, we try to make a quick introduction to <code>xgbse</code>. Refer to this <a href="https://github.com/loft-br/xgboost-survival-embeddings/blob/main/examples/how_xgbse_works.ipynb">this Notebook</a> for the full code and/or if you want a more practical introduction.</p>
<h3 id="what-xgbse-tries-to-solve"><em>What <code>xgbse</code> tries to solve</em><a class="headerlink" href="#what-xgbse-tries-to-solve" title="Permanent link">&para;</a></h3>
<p>The XGBoost implementation provides two methods for survival analysis: Cox and Accelerated Failure Time (AFT). When it comes to ordering individuals by risk, both show competitive performance (as measured by C-index) while being lightning fast.</p>
<p>However, we can observe shortcomings when it comes to other desirable statistical properties. Specifically, three properties are of concern:</p>
<ul>
<li>prediction of survival curves rather than point estimates</li>
<li>estimation of confidence intervals</li>
<li>calibrated (unbiased) expected survival times</li>
</ul>
<p>Let us take the AFT implementation as an example. The model assumes an underlying distribution for times and events, controlled by the <code>aft_loss_distribution</code> and <code>aft_loss_distribution_scale</code> hyperparameters. By tweaking the <code>aft_loss_distribution_scale</code> hyperparameter we can build models with very different average predicted survival times, while maintaing ordering, with good C-index results:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># loop to show different scale results</span>
<span class="k">for</span> <span class="n">scale</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]:</span>

    <span class="c1"># chaning parameter</span>
    <span class="n">PARAMS_XGB_AFT</span><span class="p">[</span><span class="s1">&#39;aft_loss_distribution_scale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span>

    <span class="c1"># training model</span>
    <span class="n">bst</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">train</span><span class="p">(</span>
        <span class="n">PARAMS_XGB_AFT</span><span class="p">,</span>
        <span class="n">dtrain</span><span class="p">,</span>
        <span class="n">num_boost_round</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
        <span class="n">early_stopping_rounds</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">evals</span><span class="o">=</span><span class="p">[(</span><span class="n">dval</span><span class="p">,</span> <span class="s1">&#39;val&#39;</span><span class="p">)],</span>
        <span class="n">verbose_eval</span><span class="o">=</span><span class="mi">0</span>
    <span class="p">)</span>

    <span class="c1"># predicting and evaluating</span>
    <span class="n">preds</span> <span class="o">=</span> <span class="n">bst</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">dval</span><span class="p">)</span>
    <span class="n">cind</span> <span class="o">=</span> <span class="n">concordance_index_censored</span><span class="p">(</span><span class="n">y_valid</span><span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">],</span> <span class="n">y_valid</span><span class="p">[</span><span class="s1">&#39;c2&#39;</span><span class="p">],</span> <span class="mi">1</span><span class="o">-</span><span class="n">preds</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;aft_loss_distribution_scale: </span><span class="si">{</span><span class="n">scale</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;C-index: </span><span class="si">{</span><span class="n">cind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Average survival time: </span><span class="si">{</span><span class="n">preds</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> days&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;----&quot;</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>aft_loss_distribution_scale: 1.5
C-index: 0.645
Average survival time: 203 days
----
aft_loss_distribution_scale: 1.0
C-index: 0.648
Average survival time: 165 days
----
aft_loss_distribution_scale: 0.5
C-index: 0.646
Average survival time: 125 days
----
</code></pre></div>

<p>If we plot the average predictions alongside a unbiased survival estimator such as the Kaplan Meier we can check that for each step of <code>0.5</code> in <code>aft_loss_distribution_scale</code> we move roughly one decile to the right in the curve.</p>
<p><img src="img/avg_preds_vs_kaplan_xgb.png"></p>
<p>So what predictions should we trust? Such sensitivity to hyperparameters (<code>0.003</code> C-index variation yet 78 days difference) raises red flags for applications that are dependent on robust and calibrated time-to-event estimates, mining trust and preventing shipping survival analysis models to production.</p>
<h3 id="leveraging-xgboost-as-a-feature-transformer"><em>Leveraging <code>xgboost</code> as a feature transformer</em><a class="headerlink" href="#leveraging-xgboost-as-a-feature-transformer" title="Permanent link">&para;</a></h3>
<p>Although in need of an extension for statistical rigor, <code>xgboost</code> is still a powerhouse. C-index results show that the model can capture a great deal of signal, being competitive with the state of the art. We just need to adapt how we use it.</p>
<p>Besides being leveraged for prediction tasks, Gradient Boosted Trees (GBTs) can also be used as <strong><em>feature transformers</em></strong> of the input data. Trees in the ensemble perform splits on features that discriminate the target, encoding the most relevant information for the task at hand in their structure. In particular, the terminal nodes (leaves) at each tree in the ensemble define a <strong><em><a href="http://scikit-learn.org/stable/auto_examples/ensemble/plot_feature_transformation.html">sparse supervised feature transformation</a> (embedding)</em></strong> of the input data.</p>
<p>This kind of <em>tree ensemble embedding</em> has very convenient properties:</p>
<ol>
<li>
<p><strong>sparsity and high-dimensionality:</strong> trees deal with nonlinearity and cast original features to a sparse, high-dimensional embedding, which helps linear models perform well when trained on it. This allows a <strong>Logistic Regression</strong> trained on the embedding (as one-hot encoded leaf indices) to have comparable performance to the actual ensemble, with the added benefit of probability calibration (see [1], [2], and [3])</p>
</li>
<li>
<p><strong>supervision:</strong> trees also work as a noise filter, performing splits only through features that have predictive power. Thus, the embedding actually has a lower intrinsic dimension than the input data. This mitigates the curse of dimensionality and allows a <strong>K-Nearest Neighbor</strong> model trained on the embedding (using hamming distance) to have comparable performance to the actual ensemble, with the added flexibility to apply any function over the neighbor-sets to get predictions. This arbitrary function can be, for instance, an unbiased survival estimator such as the Kaplan-Meier estimator (see [4])</p>
</li>
</ol>
<p>We take advantage of these properties in different ways as we will show in the next subsections.</p>
<h3 id="xgbsedebiasedbce-logistic-regressions-time-windows-embedding-as-input"><em><code>XGBSEDebiasedBCE</code>: logistic regressions, time windows, embedding as input</em><a class="headerlink" href="#xgbsedebiasedbce-logistic-regressions-time-windows-embedding-as-input" title="Permanent link">&para;</a></h3>
<p>Our first approach, <code>XGBSEDebiasedBCE</code>, takes inspiration from the multi-task logistic regression method in [5], the BCE approach in [6], and the probability calibration ideas from [1], [2] and [3].</p>
<p>It consists of training a set of logistic regressions on top of the embedding produced by <code>xgboost</code>, each predicting survival at different user-defined discrete time windows. The classifiers remove individuals as they are censored, with targets that are indicators of surviving at each window.</p>
<p><img src="img/xgb_bce_diagram.svg"></p>
<p>The naive approach tends to give biased survival curves, due to the removal of censored individuals. Thus, we made some adaptations such that logistic regressions estimate the <code>di/ni</code> term (point probabilities) in the <a href="https://www.math.wustl.edu/~sawyer/handouts/greenwood.pdf">Kaplan-Meier formula</a> and then use the KM estimator to get nearly unbiased survival curves.</p>
<p>This way, we can get full survival curves from <code>xgboost</code>, and confidence intervals with minor adaptations (such as performing some rounds of bootstrap).</p>
<p>Training and scoring of logistic regression models is efficient, being performed in parallel through <code>joblib</code>, so the model can scale to hundreds of thousands or millions of samples.</p>
<h3 id="xgbsekaplanneighbors-kaplan-meier-on-nearest-neighbors"><em><code>XGBSEKaplanNeighbors</code>: Kaplan-Meier on nearest neighbors</em><a class="headerlink" href="#xgbsekaplanneighbors-kaplan-meier-on-nearest-neighbors" title="Permanent link">&para;</a></h3>
<p>As explained in the previous section, even though the embedding produced by <code>xgboost</code> is sparse and high dimensional, its intrisic dimensionality actually should be lower than the input data. This enables us to "convert" <code>xgboost</code> into a nearest neighbor model, where we use hamming distance to define similar elements as the ones that co-occurred the most at the ensemble terminal nodes. Then, at each neighbor-set we can get survival estimates with robust methods such as the Kaplan-Meier estimator.</p>
<p><img src="img/xgb_neighbors_diagram.svg"></p>
<p>We recommend using <code>dart</code> as the booster to prevent any tree to dominate variance in the ensemble and break the leaf co-ocurrence similarity logic. We built a high-performing implementation of the KM estimator to calculate several survival curves in a vectorized fashion, including upper and lower confidence intervals based on the Exponential Greenwood formula.</p>
<p>However, this method can be very expensive at scales of hundreds of thousands of samples, due to the nearest neighbor search, both on training (construction of search index) and scoring (actual search).</p>
<h3 id="xgbsekaplantree-single-tree-and-kaplan-meier-on-its-leaves"><em><code>XGBSEKaplanTree</code>: single tree, and Kaplan-Meier on its leaves</em><a class="headerlink" href="#xgbsekaplantree-single-tree-and-kaplan-meier-on-its-leaves" title="Permanent link">&para;</a></h3>
<p>As a simplification to <code>XGBSEKaplanNeighbors</code>, we also provide a single tree implementation. Instead of doing expensive nearest neighbor searches, we fit a single tree via <code>xgboost</code> and calculate KM curves at each of its leaves.</p>
<p><img src="img/xgb_tree_diagram.svg"></p>
<p>It is by far the most efficient implementation, able to scale to millions of examples easily. At fit time, the tree is built and all KM curves are pre-calculated, so that at scoring time a simple query will suffice to get the model's estimates.</p>
<p>However, as we're fitting a single tree, predictive power may be worse. That could be a sensible tradeoff, but we also provide <code>XGBSEBootstrapEstimator</code>, a bootstrap abstraction where we can fit a forest of <code>XGBSEKaplanTree</code>'s to improve accuracy and reduce variance.</p>
<h3 id="does-it-solve-the-problem"><em>Does it solve the problem?</em><a class="headerlink" href="#does-it-solve-the-problem" title="Permanent link">&para;</a></h3>
<p>Now we return to the first example and check how <code>XGBEmbedKaplanNeighbors</code> performs:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># loop to show different scale results</span>
<span class="k">for</span> <span class="n">scale</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]:</span>

    <span class="c1"># chaning parameter</span>
    <span class="n">PARAMS_XGB_AFT</span><span class="p">[</span><span class="s1">&#39;aft_loss_distribution_scale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span>

    <span class="c1"># training model</span>
    <span class="n">xgbse_model</span> <span class="o">=</span> <span class="n">XGBSEKaplanNeighbors</span><span class="p">(</span><span class="n">PARAMS_XGB_AFT</span><span class="p">,</span> <span class="n">n_neighbors</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
    <span class="n">xgbse_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
        <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span>
        <span class="n">validation_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">X_valid</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">),</span>
        <span class="n">early_stopping_rounds</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">time_bins</span><span class="o">=</span><span class="n">TIME_BINS</span>
    <span class="p">)</span>

    <span class="c1"># predicting and evaluating</span>
    <span class="n">preds</span> <span class="o">=</span> <span class="n">xgbse_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_valid</span><span class="p">)</span>
    <span class="n">cind</span> <span class="o">=</span> <span class="n">concordance_index_censored</span><span class="p">(</span><span class="n">y_valid</span><span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">],</span> <span class="n">y_valid</span><span class="p">[</span><span class="s1">&#39;c2&#39;</span><span class="p">],</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">preds</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">avg_probs</span> <span class="o">=</span> <span class="n">preds</span><span class="p">[[</span><span class="mi">30</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">150</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;aft_loss_distribution_scale: </span><span class="si">{</span><span class="n">scale</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;C-index: </span><span class="si">{</span><span class="n">cind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Average probability of survival at [30, 90, 150] days: </span><span class="si">{</span><span class="n">avg_probs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;----&quot;</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">aft_loss_distribution_scale</span><span class="o">:</span> <span class="mf">1.5</span>
<span class="n">C</span><span class="o">-</span><span class="n">index</span><span class="o">:</span> <span class="mf">0.640</span>
<span class="n">Average</span> <span class="n">probability</span> <span class="n">of</span> <span class="n">survival</span> <span class="n">at</span> <span class="o">[</span><span class="mi">30</span><span class="o">,</span> <span class="mi">90</span><span class="o">,</span> <span class="mi">150</span><span class="o">]</span> <span class="n">days</span><span class="o">:</span> <span class="o">[</span><span class="mf">0.9109</span><span class="o">,</span> <span class="mf">0.6854</span><span class="o">,</span> <span class="mf">0.528</span><span class="o">]</span>
<span class="o">----</span>
<span class="n">aft_loss_distribution_scale</span><span class="o">:</span> <span class="mf">1.0</span>
<span class="n">C</span><span class="o">-</span><span class="n">index</span><span class="o">:</span> <span class="mf">0.644</span>
<span class="n">Average</span> <span class="n">probability</span> <span class="n">of</span> <span class="n">survival</span> <span class="n">at</span> <span class="o">[</span><span class="mi">30</span><span class="o">,</span> <span class="mi">90</span><span class="o">,</span> <span class="mi">150</span><span class="o">]</span> <span class="n">days</span><span class="o">:</span> <span class="o">[</span><span class="mf">0.9111</span><span class="o">,</span> <span class="mf">0.6889</span><span class="o">,</span> <span class="mf">0.5333</span><span class="o">]</span>
<span class="o">----</span>
<span class="n">aft_loss_distribution_scale</span><span class="o">:</span> <span class="mf">0.5</span>
<span class="n">C</span><span class="o">-</span><span class="n">index</span><span class="o">:</span> <span class="mf">0.650</span>
<span class="n">Average</span> <span class="n">probability</span> <span class="n">of</span> <span class="n">survival</span> <span class="n">at</span> <span class="o">[</span><span class="mi">30</span><span class="o">,</span> <span class="mi">90</span><span class="o">,</span> <span class="mi">150</span><span class="o">]</span> <span class="n">days</span><span class="o">:</span> <span class="o">[</span><span class="mf">0.913</span><span class="o">,</span> <span class="mf">0.6904</span><span class="o">,</span> <span class="mf">0.5289</span><span class="o">]</span>
<span class="o">----</span>
</code></pre></div>

<p>As measured by the average probability of survival in 30, 90 and 150 days the model is very stable, showing similar calibration results independently of <code>aft_loss_distribution_scale</code> choice, with comparable (or a bit worse) C-index results. Visually, the comparison of the average model predictions to a Kaplan Meier yields much better results:</p>
<p><img src="img/avg_preds_vs_kaplan_xgbse.png"></p>
<p>No more point estimates and high variation! Although is too harsh to claim that the problem is solved, we believe that the package can be a good, more statistically robust alternative to survival analysis.</p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../metrics.html" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Metrics
              </div>
            </div>
          </a>
        
        
          <a href="../benchmarks/benchmarks.html" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Benchmarks
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.93c04032.min.js"></script>
      <script src="../assets/javascripts/bundle.83e5331e.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: [],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.8c7e0a7e.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>